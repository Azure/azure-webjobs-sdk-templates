name: $(Build.SourceBranchName)_$(Build.Reason)_$(devops_buildNumber)

pr:
  branches:
    include:
    - master
    - dev

trigger:
  branches:
    include:
    - dev
    - master

pool:
  vmImage: 'vs2017-win2016'

variables:
  devops_buildNumber: $[counter(format(''), 11000)]
  APPVEYOR_REPO_BRANCH: $[coalesce(variables['System.PullRequest.TargetBranch'], variables['Build.SourceBranchName'])]
  APPVEYOR_REPO_COMMIT: $(Build.SourceVersion)
  APPVEYOR_BUILD_VERSION: 3.0.$(devops_buildNumber)

steps:
- task: PowerShell@2
  inputs:
    filePath: '.\getTools.ps1'
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      Set-Location .\Functions.Templates
          $hasTag = Test-Path env:APPVEYOR_REPO_TAG_NAME
          $msbuild = "C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\MSBuild\15.0\Bin\msbuild.exe"
          if ($hasTag)
          {
            $msbuild Functions.Templates.csproj /p:TemplateVersion=$env:APPVEYOR_REPO_TAG_NAME /target:PortalTemplatesPkg /target:VisualStudioTemplates  
          } else {
            $msbuild Functions.Templates.csproj /p:TemplateVersion=$env:APPVEYOR_BUILD_VERSION /target:PortalTemplatesPkg /target:VisualStudioTemplates
          }